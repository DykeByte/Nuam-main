version: "3.9"

services:
  # ========================================
  # BASE DE DATOS - FIX HEALTHCHECK
  # ========================================
  postgres:
    image: postgres:15
    container_name: nuam-postgres
    environment:
      POSTGRES_DB: nuam_db
      POSTGRES_USER: nuam_user
      POSTGRES_PASSWORD: nuam_password
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - nuam-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U nuam_user -d nuam_db"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # ========================================
  # REDIS (CACHE)
  # ========================================
  redis:
    image: redis:7-alpine
    container_name: nuam-redis
    command: redis-server --appendonly yes
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - nuam-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # ========================================
  # ZOOKEEPER
  # ========================================
  zookeeper:
    image: confluentinc/cp-zookeeper:7.4.4
    container_name: nuam-zookeeper
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    networks:
      - nuam-network
    healthcheck:
      test: ["CMD", "echo", "ruok", "|", "nc", "localhost", "2181"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # ========================================
  # KAFKA
  # ========================================
  kafka:
    image: confluentinc/cp-kafka:7.4.4
    container_name: nuam-kafka
    depends_on:
      zookeeper:
        condition: service_healthy
    ports:
      - "9092:9092"
    networks:
      - nuam-network
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:29092,PLAINTEXT_HOST://localhost:9092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
    healthcheck:
      test: ["CMD-SHELL", "kafka-broker-api-versions --bootstrap-server localhost:9092 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 40s
    restart: unless-stopped

  # ========================================
  # CURRENCY SERVICE (FastAPI)
  # ========================================
  currency-service:
    build:
      context: ./services/currency-service
      dockerfile: Dockerfile
    container_name: nuam-currency-service
    environment:
      DATABASE_URL: postgresql://nuam_user:nuam_password@postgres:5432/nuam_db
      REDIS_URL: redis://redis:6379/0
    ports:
      - "8001:8001"
    volumes:
      - ./services/currency-service/app:/app
      - ./logs:/app/logs
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - nuam-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/api/health/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    restart: unless-stopped

  # ========================================
  # DJANGO CORE SERVICE
  # ========================================
  django-core:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: nuam-django-core
    command: >
      sh -c "python manage.py migrate &&
             python manage.py collectstatic --noinput &&
             python manage.py runserver 0.0.0.0:8000"
    env_file:
      - .env
    environment:
      DATABASE_NAME: nuam_db
      DATABASE_USER: nuam_user
      DATABASE_PASSWORD: nuam_password
      DATABASE_HOST: postgres
      DATABASE_PORT: 5432
      DATABASE_URL: postgresql://nuam_user:nuam_password@postgres:5432/nuam_db
      KAFKA_BOOTSTRAP_SERVERS: kafka:29092
      CURRENCY_SERVICE_URL: http://currency-service:8001
      REDIS_URL: redis://redis:6379/1
    ports:
      - "8000:8000"
    volumes:
      - .:/app
      - ./logs:/app/logs
      - static_volume:/app/staticfiles
    depends_on:
      postgres:
        condition: service_healthy
      kafka:
        condition: service_healthy
      currency-service:
        condition: service_healthy
    networks:
      - nuam-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/v1/health/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    restart: unless-stopped

  # ========================================
  # KAFKA CONSUMER
  # ========================================
  kafka-consumer:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: nuam-kafka-consumer
    command: python manage.py run_kafka_consumers
    env_file:
      - .env
    environment:
      DATABASE_NAME: nuam_db
      DATABASE_USER: nuam_user
      DATABASE_PASSWORD: nuam_password
      DATABASE_HOST: postgres
      DATABASE_PORT: 5432
      KAFKA_BOOTSTRAP_SERVERS: kafka:29092
    volumes:
      - .:/app
      - ./logs:/app/logs
    depends_on:
      postgres:
        condition: service_healthy
      kafka:
        condition: service_healthy
      django-core:
        condition: service_healthy
    networks:
      - nuam-network
    restart: unless-stopped

  # ========================================
  # DASHBOARD FRONTEND (React)
  # ========================================
  dashboard-frontend:
    build:
      context: ./services/dashboard-frontend
      dockerfile: Dockerfile
    container_name: nuam-dashboard-frontend
    environment:
      VITE_API_URL: http://localhost/api/v1
      VITE_CURRENCY_API_URL: http://localhost/currency-api/v1
    ports:
      - "3000:3000"
    volumes:
      - ./services/dashboard-frontend/src:/app/src
      - ./services/dashboard-frontend/public:/app/public
      - /app/node_modules
    networks:
      - nuam-network
    restart: unless-stopped

  # ========================================
  # NGINX (Internal Routing Layer)
  # ========================================
  nginx:
    image: nginx:alpine
    container_name: nuam-nginx
    ports:
      - "8080:80"  # Expose internally for Apache2
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
      - ./certs:/etc/nginx/certs:ro
      - static_volume:/var/www/static:ro
    depends_on:
      - django-core
      - currency-service
      - dashboard-frontend
    networks:
      - nuam-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  # ========================================
  # APACHE2 (Primary Reverse Proxy & SSL)
  # ========================================
  apache2:
    build:
      context: ./apache
      dockerfile: Dockerfile
    container_name: nuam-apache2
    ports:
      - "80:80"    # HTTP
      - "443:443"  # HTTPS
    volumes:
      - ./apache/httpd.conf:/usr/local/apache2/conf/httpd.conf:ro
      - ./apache/conf.d:/usr/local/apache2/conf/conf.d:ro
      - ./certs:/usr/local/apache2/conf/ssl:ro
    environment:
      - TZ=America/Santiago
    depends_on:
      - nginx
    networks:
      - nuam-network
    healthcheck:
      test: ["CMD", "httpd", "-t"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    restart: unless-stopped

# ========================================
# REDES Y VOLUMENES
# ========================================
networks:
  nuam-network:
    driver: bridge

volumes:
  postgres_data:
  redis_data:
  static_volume: