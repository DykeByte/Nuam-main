<!-- ============================================ -->
<!-- home.html con Widget de ConversiÃ³n de Divisas -->
<!-- ============================================ -->
{% extends 'base.html' %}

{% block title %}Dashboard - NUAM{% endblock %}

{% block content %}
<h1 style="color: white; margin-bottom: 2rem;">Bienvenido, {{ user.username }}</h1>

<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
    <div class="card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; text-align: center;">
        <h2 style="font-size: 3rem; margin-bottom: 0.5rem;">{{ total_calificaciones }}</h2>
        <p style="font-size: 1.2rem; opacity: 0.9;">Calificaciones</p>
    </div>
    
    <div class="card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; text-align: center;">
        <h2 style="font-size: 3rem; margin-bottom: 0.5rem;">{{ total_cargas }}</h2>
        <p style="font-size: 1.2rem; opacity: 0.9;">Cargas Realizadas</p>
    </div>
    
    <div class="card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; text-align: center;">
        <h2 style="font-size: 3rem; margin-bottom: 0.5rem;">100%</h2>
        <p style="font-size: 1.2rem; opacity: 0.9;">Sistema Activo</p>
    </div>
</div>

<!-- ============================================ -->
<!-- NUEVO: Widget de ConversiÃ³n de Divisas -->
<!-- ============================================ -->
<div class="card" style="margin-bottom: 2rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
    <h2 style="margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.5rem;">
        <span style="font-size: 1.5rem;">ðŸ’±</span>
        Conversor de Divisas en Tiempo Real
    </h2>
    
    <div style="background: rgba(255, 255, 255, 0.1); padding: 1.5rem; border-radius: 10px;">
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; align-items: end;">
            <div>
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Monto</label>
                <input type="number" id="amount" value="100" 
                       style="width: 100%; padding: 0.8rem; border: none; border-radius: 5px; font-size: 1.1rem;">
            </div>
            
            <div>
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">De</label>
                <select id="from_currency" 
                        style="width: 100%; padding: 0.8rem; border: none; border-radius: 5px; font-size: 1.1rem;">
                    <option value="USD" selected>USD - DÃ³lar</option>
                    <option value="EUR">EUR - Euro</option>
                    <option value="CLP">CLP - Peso Chileno</option>
                    <option value="COP">COP - Peso Colombiano</option>
                    <option value="PEN">PEN - Sol Peruano</option>
                    <option value="MXN">MXN - Peso Mexicano</option>
                    <option value="BRL">BRL - Real BrasileÃ±o</option>
                    <option value="ARS">ARS - Peso Argentino</option>
                </select>
            </div>
            
            <div>
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">A</label>
                <select id="to_currency" 
                        style="width: 100%; padding: 0.8rem; border: none; border-radius: 5px; font-size: 1.1rem;">
                    <option value="CLP" selected>CLP - Peso Chileno</option>
                    <option value="USD">USD - DÃ³lar</option>
                    <option value="EUR">EUR - Euro</option>
                    <option value="COP">COP - Peso Colombiano</option>
                    <option value="PEN">PEN - Sol Peruano</option>
                    <option value="MXN">MXN - Peso Mexicano</option>
                    <option value="BRL">BRL - Real BrasileÃ±o</option>
                    <option value="ARS">ARS - Peso Argentino</option>
                </select>
            </div>
        </div>
        
        <div id="conversion_result" style="margin-top: 1.5rem; padding: 1.5rem; background: rgba(255, 255, 255, 0.2); border-radius: 10px; text-align: center;">
            <div style="font-size: 0.9rem; opacity: 0.9; margin-bottom: 0.5rem;">Resultado de la conversiÃ³n:</div>
            <div id="result_text" style="font-size: 2rem; font-weight: bold;">Ingrese un monto</div>
            <div id="rate_text" style="font-size: 0.9rem; opacity: 0.8; margin-top: 0.5rem;">Tasa: -</div>
            <div id="timestamp" style="font-size: 0.75rem; opacity: 0.7; margin-top: 0.5rem;">-</div>
        </div>
        
        <div id="loading" style="display: none; text-align: center; padding: 1rem;">
            <div style="display: inline-block; width: 30px; height: 30px; border: 3px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: white; animation: spin 1s ease-in-out infinite;"></div>
        </div>
        
        <div id="error_message" style="display: none; margin-top: 1rem; padding: 1rem; background: rgba(255, 0, 0, 0.2); border-radius: 5px; text-align: center;">
            Error al obtener la conversiÃ³n
        </div>
    </div>
</div>

<style>
@keyframes spin {
    to { transform: rotate(360deg); }
}
</style>

<script>
// ============================================
// JavaScript para ConversiÃ³n en Tiempo Real
// ============================================
let conversionTimeout;

function convertCurrency() {
    const amount = document.getElementById('amount').value;
    const fromCurrency = document.getElementById('from_currency').value;
    const toCurrency = document.getElementById('to_currency').value;
    
    const resultDiv = document.getElementById('conversion_result');
    const loadingDiv = document.getElementById('loading');
    const errorDiv = document.getElementById('error_message');
    const resultText = document.getElementById('result_text');
    const rateText = document.getElementById('rate_text');
    const timestampText = document.getElementById('timestamp');
    
    // Validaciones
    if (!amount || amount <= 0) {
        resultText.textContent = 'Ingrese un monto vÃ¡lido';
        rateText.textContent = 'Tasa: -';
        timestampText.textContent = '-';
        return;
    }
    
    if (fromCurrency === toCurrency) {
        resultText.textContent = `${parseFloat(amount).toFixed(2)} ${toCurrency}`;
        rateText.textContent = 'Tasa: 1.00 (misma moneda)';
        timestampText.textContent = new Date().toLocaleString('es-CL');
        return;
    }
    
    // Mostrar loading
    resultDiv.style.display = 'none';
    errorDiv.style.display = 'none';
    loadingDiv.style.display = 'block';
    
    // Hacer request AJAX
    fetch(`/api/v1/divisas/tasa-ajax/?from=${fromCurrency}&to=${toCurrency}`)
        .then(response => response.json())
        .then(data => {
            loadingDiv.style.display = 'none';
            
            if (data.success) {
                const rate = parseFloat(data.rate);
                const convertedAmount = amount * rate;
                
                resultText.textContent = `${convertedAmount.toLocaleString('es-CL', {minimumFractionDigits: 2, maximumFractionDigits: 2})} ${toCurrency}`;
                rateText.textContent = `Tasa: 1 ${fromCurrency} = ${rate.toLocaleString('es-CL', {minimumFractionDigits: 4, maximumFractionDigits: 4})} ${toCurrency}`;
                timestampText.textContent = `Actualizado: ${new Date().toLocaleString('es-CL')}`;
                
                resultDiv.style.display = 'block';
            } else {
                errorDiv.textContent = data.error || 'Error al obtener la conversiÃ³n';
                errorDiv.style.display = 'block';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            loadingDiv.style.display = 'none';
            errorDiv.textContent = 'Error de conexiÃ³n. Intente nuevamente.';
            errorDiv.style.display = 'block';
        });
}

// Debounce para no hacer demasiadas requests
function debouncedConvert() {
    clearTimeout(conversionTimeout);
    conversionTimeout = setTimeout(convertCurrency, 500);
}

// Event listeners
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('amount').addEventListener('input', debouncedConvert);
    document.getElementById('from_currency').addEventListener('change', convertCurrency);
    document.getElementById('to_currency').addEventListener('change', convertCurrency);
    
    // ConversiÃ³n inicial
    convertCurrency();
});
</script>

<!-- ============================================ -->
<!-- Resto del Dashboard -->
<!-- ============================================ -->
<div style="display: grid; grid-template-columns: 2fr 1fr; gap: 1.5rem;">
    <div class="card">
        <h2 style="color: #667eea; margin-bottom: 1.5rem;">Acciones RÃ¡pidas</h2>
        
        <div style="display: flex; flex-direction: column; gap: 1rem;">
            <a href="{% url 'accounts:nueva_carga' %}" class="btn btn-primary" style="text-align: center;">
                ðŸ“¤ Nueva Carga Masiva
            </a>
            
            <a href="{% url 'accounts:lista_calificaciones' %}" class="btn btn-secondary" style="text-align: center;">
                ðŸ“‹ Ver Calificaciones
            </a>
            
            <a href="{% url 'accounts:lista_logs' %}" class="btn btn-secondary" style="text-align: center;">
                ðŸ“Š Historial de Operaciones
            </a>
        </div>
    </div>
    
    <div class="card">
        <h2 style="color: #667eea; margin-bottom: 1.5rem;">Ãšltimas Cargas</h2>
        
        {% if ultimas_cargas %}
        <div style="display: flex; flex-direction: column; gap: 1rem;">
            {% for carga in ultimas_cargas %}
            <div style="padding: 1rem; background: #f8f9fa; border-radius: 5px;">
                <div style="font-weight: 600; color: #333;">{{ carga.tipo_carga }}</div>
                <div style="font-size: 0.9rem; color: #666;">{{ carga.fecha_carga|date:"d/m/Y H:i" }}</div>
                <div style="font-size: 0.85rem; color: #28a745; margin-top: 0.5rem;">
                    âœ“ {{ carga.registros_exitosos }} exitosos
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p style="color: #999; text-align: center; padding: 2rem 0;">
            No hay cargas registradas aÃºn
        </p>
        {% endif %}
    </div>
</div>

<div class="card" style="margin-top: 2rem;">
    <h2 style="color: #667eea; margin-bottom: 1rem;">InformaciÃ³n del Sistema</h2>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
        <div>
            <strong>Usuario:</strong> {{ user.username }}
        </div>
        <div>
            <strong>Email:</strong> {{ user.email }}
        </div>
        <div>
            <strong>Estado:</strong> <span style="color: #28a745;">âœ“ Activo</span>
        </div>
        <div>
            <strong>Ãšltima sesiÃ³n:</strong> {{ user.last_login|date:"d/m/Y H:i" }}
        </div>
    </div>
</div>
{% endblock %}