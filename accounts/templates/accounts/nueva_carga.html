{% extends 'base.html' %}

{% block title %}Nueva Carga - NUAM{% endblock %}

{% block content %}
<div class="card" style="max-width: 900px; margin: 0 auto;">
    <h1 style="color: #667eea; margin-bottom: 2rem;">Nueva Carga Masiva</h1>
    
    <form method="post" enctype="multipart/form-data">
        {% csrf_token %}
        
        <div style="margin-bottom: 2rem;">
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Tipo de Carga</label>
            <select name="tipo_carga" id="tipoCarga" required
                style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 5px; font-size: 1rem;">
                <option value="">Selecciona un tipo</option>
                <option value="FACTORES">Factores (Incluye todos los factores del 8 al 37)</option>
                <option value="MONITOR">Monitor (Solo datos b√°sicos)</option>
            </select>
        </div>
        
        <div style="margin-bottom: 2rem;">
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Archivo Excel (.xlsx)</label>
            <div style="border: 2px dashed #667eea; border-radius: 10px; padding: 3rem; text-align: center; background: #f8f9fa;">
                <input type="file" name="archivo" accept=".xlsx,.xls" required
                    style="display: none;" id="fileInput">
                <label for="fileInput" style="cursor: pointer;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">üìÅ</div>
                    <p style="color: #667eea; font-weight: 600; margin-bottom: 0.5rem;">Haz click para seleccionar archivo</p>
                    <p style="color: #999; font-size: 0.9rem;">Formatos aceptados: .xlsx, .xls (M√°ximo 5MB)</p>
                </label>
                <div id="fileName" style="margin-top: 1rem; color: #28a745; font-weight: 600;"></div>
            </div>
        </div>
        
        <!-- Informaci√≥n sobre columnas esperadas -->
        <div style="background: #d1ecf1; padding: 1.5rem; border-radius: 5px; border-left: 4px solid #17a2b8; margin-bottom: 2rem;">
            <h3 style="color: #0c5460; margin-bottom: 1rem;">‚ÑπÔ∏è Columnas Requeridas</h3>
            
            <div id="columnasInfo" style="display: none;">
                <div id="columnasFactores" style="display: none;">
                    <h4 style="color: #0c5460; margin-bottom: 0.5rem;">Tipo FACTORES:</h4>
                    <ul style="color: #0c5460; margin: 0; padding-left: 1.5rem; columns: 2;">
                        <li>corredor_dueno</li>
                        <li>rut</li>
                        <li>ano_comercial</li>
                        <li>mercado</li>
                        <li>instrumento</li>
                        <li>fecha_pago</li>
                        <li>secuencia_evento</li>
                        <li>numero_dividendo</li>
                        <li>descripcion</li>
                        <li>tipo_sociedad</li>
                        <li>acopio_lsfxf</li>
                        <li>valor_historico</li>
                        <li>factor_actualizacion</li>
                        <li>es_local</li>
                        <li>factor_8 a factor_37 (30 columnas)</li>
                    </ul>
                </div>
                
                <div id="columnasMonitor" style="display: none;">
                    <h4 style="color: #0c5460; margin-bottom: 0.5rem;">Tipo MONITOR:</h4>
                    <ul style="color: #0c5460; margin: 0; padding-left: 1.5rem; columns: 2;">
                        <li>corredor_dueno</li>
                        <li>rut</li>
                        <li>ano_comercial</li>
                        <li>mercado</li>
                        <li>instrumento</li>
                        <li>fecha_pago</li>
                        <li>secuencia_evento</li>
                        <li>numero_dividendo</li>
                        <li>descripcion</li>
                        <li>tipo_sociedad</li>
                        <li>acopio_lsfxf</li>
                        <li>valor_historico</li>
                        <li>factor_actualizacion</li>
                        <li>es_local</li>
                    </ul>
                </div>
            </div>
        </div>
        
        <div style="background: #fff3cd; padding: 1.5rem; border-radius: 5px; border-left: 4px solid #ffc107; margin-bottom: 2rem;">
            <h3 style="color: #856404; margin-bottom: 0.5rem;">‚ö†Ô∏è Recomendaciones</h3>
            <ul style="color: #856404; margin: 0; padding-left: 1.5rem;">
                <li>Usa la primera fila como encabezado con los nombres exactos de las columnas</li>
                <li>Las fechas deben estar en formato: YYYY-MM-DD (ej: 2024-12-31)</li>
                <li>Los valores booleanos pueden ser: true/false, 1/0, s√≠/no</li>
                <li>Los decimales pueden usar punto o coma</li>
                <li>Para pruebas, usa m√°ximo 100 registros</li>
            </ul>
        </div>
        
        <div style="display: flex; gap: 1rem;">
            <button type="submit" class="btn btn-primary">üì§ Subir y Procesar</button>
            <a href="{% url 'accounts:lista_cargas' %}" class="btn btn-secondary">Cancelar</a>
        </div>
    </form>
    
    <!-- Bot√≥n para descargar plantilla -->
    <div style="margin-top: 2rem; padding: 1.5rem; background: #e7f3ff; border-radius: 5px; text-align: center;">
        <p style="color: #004085; margin-bottom: 1rem;">
            <strong>¬øPrimera vez?</strong> Descarga la plantilla de ejemplo
        </p>
        <a href="{% url 'accounts:descargar_plantilla' %}" class="btn btn-primary" style="text-decoration: none;">
            üì• Descargar Plantilla Excel
        </a>
    </div>
</div>

<script>
    // Mostrar nombre del archivo seleccionado
    document.getElementById('fileInput').addEventListener('change', function(e) {
        const fileName = e.target.files[0]?.name;
        const fileSize = e.target.files[0]?.size;
        const fileNameDiv = document.getElementById('fileName');
        
        if (fileName) {
            const sizeMB = (fileSize / (1024 * 1024)).toFixed(2);
            fileNameDiv.innerHTML = `‚úì Archivo seleccionado: <strong>${fileName}</strong><br>Tama√±o: ${sizeMB} MB`;
        }
    });
    
    // Mostrar columnas seg√∫n tipo de carga
    document.getElementById('tipoCarga').addEventListener('change', function(e) {
        const tipo = e.target.value;
        const columnasInfo = document.getElementById('columnasInfo');
        const columnasFactores = document.getElementById('columnasFactores');
        const columnasMonitor = document.getElementById('columnasMonitor');
        
        if (tipo === 'FACTORES') {
            columnasInfo.style.display = 'block';
            columnasFactores.style.display = 'block';
            columnasMonitor.style.display = 'none';
        } else if (tipo === 'MONITOR') {
            columnasInfo.style.display = 'block';
            columnasFactores.style.display = 'none';
            columnasMonitor.style.display = 'block';
        } else {
            columnasInfo.style.display = 'none';
        }
    });
</script>
{% endblock %}