{% extends 'base.html' %}
{% load widget_tweaks %}

{% block title %}Nueva Carga - NUAM{% endblock %}

{% block content %}
<div class="card" style="max-width: 900px; margin: 0 auto;">
    <h1 style="color: #667eea; margin-bottom: 2rem;">Nueva Carga Masiva</h1>

    <form method="post" enctype="multipart/form-data">
        {% csrf_token %}

        {% if form.non_field_errors %}
            <div class="alert alert-danger">
                {% for error in form.non_field_errors %}
                    <p>{{ error }}</p>
                {% endfor %}
            </div>
        {% endif %}

        <!-- Tipo de carga -->
        <div style="margin-bottom: 2rem;">
            <label for="id_tipo_carga" style="display: block; font-weight: 600; color: #333; margin-bottom: 0.5rem; font-size: 1rem;">
                Tipo de carga:
            </label>
            {{ form.tipo_carga|add_class:"form-control" }}
            {% if form.tipo_carga.errors %}
                <div class="text-danger" style="margin-top: 0.5rem;">{{ form.tipo_carga.errors }}</div>
            {% endif %}
        </div>

        <!-- Archivo -->
        <div style="margin-bottom: 2rem;">
            <label style="display: block; font-weight: 600; color: #333; margin-bottom: 0.75rem; font-size: 1rem;">
                Archivo Excel/CSV:
            </label>
            <div style="border: 2px dashed #667eea; border-radius: 10px; padding: 2.5rem 2rem; text-align: center; background: #f8f9fa; transition: all 0.3s ease;">
                
                <input type="file" id="id_archivo" name="archivo" accept=".xlsx,.xls" style="display: none;" required>
                
                <label for="id_archivo" style="cursor: pointer; display: block;">
                    <div style="font-size: 3.5rem; margin-bottom: 1rem;">üìÅ</div>
                    <p style="color: #667eea; font-weight: 600; margin-bottom: 0.5rem; font-size: 1.1rem;">
                        Haz click para seleccionar archivo
                    </p>
                    <p style="color: #6c757d; font-size: 0.9rem; margin: 0;">
                        Formatos aceptados: <strong>.xlsx</strong>, <strong>.xls</strong> (M√°ximo 5MB)
                    </p>
                </label>

                <div id="fileName" style="margin-top: 1.5rem; padding: 0.75rem; border-radius: 5px; display: none;"></div>
            </div>

            {% if form.archivo.errors %}
                <div class="text-danger" style="margin-top: 0.75rem; padding: 0.5rem; background: #f8d7da; border-radius: 5px;">
                    {{ form.archivo.errors }}
                </div>
            {% endif %}
        </div>

        <!-- Mercado -->
        <div style="margin-bottom: 2rem;">
            <label for="id_mercado" style="display: block; font-weight: 600; color: #333; margin-bottom: 0.5rem; font-size: 1rem;">
                Mercado:
            </label>
            {{ form.mercado|add_class:"form-control" }}
            {% if form.mercado.errors %}
                <div class="text-danger" style="margin-top: 0.5rem;">{{ form.mercado.errors }}</div>
            {% endif %}
        </div>

        <!-- Info sobre estructura del archivo Excel -->
        <div style="background: #d1ecf1; padding: 1.5rem; border-radius: 5px; border-left: 4px solid #17a2b8; margin-bottom: 2rem;">
            <h3 style="color: #0c5460; margin-bottom: 1rem;">‚ÑπÔ∏è Estructura del Archivo Excel</h3>
            
            <div style="color: #0c5460;">
                <p style="margin-bottom: 1rem;">
                    <strong>Tu archivo Excel debe contener:</strong>
                </p>
                
                <ul style="padding-left: 1.5rem; margin-bottom: 1rem;">
                    <li><strong>Una fila de encabezado</strong> con los nombres exactos de las columnas</li>
                    <li><strong>Columnas b√°sicas obligatorias:</strong> corredor_dueno, rut, ano_comercial, mercado, instrumento, fecha_pago, secuencia_evento, numero_dividendo, descripcion, tipo_sociedad, acopio_lsfxf, valor_historico, factor_actualizacion, es_local</li>
                    <li id="columnasExtras" style="display: none;"><strong>Para tipo FACTORES:</strong> Adem√°s incluye columnas factor_8 hasta factor_37 (30 columnas adicionales)</li>
                </ul>

                <div style="background: white; padding: 1rem; border-radius: 5px; margin-top: 1rem;">
                    <p style="margin: 0; font-size: 0.95rem;">
                        üí° <strong>Tip:</strong> Descarga la plantilla de ejemplo m√°s abajo para asegurarte de que tu archivo tenga la estructura correcta.
                    </p>
                </div>
            </div>
        </div>

        <!-- Recomendaciones -->
        <div style="background: #fff3cd; padding: 1.5rem; border-radius: 5px; border-left: 4px solid #ffc107; margin-bottom: 2rem;">
            <h3 style="color: #856404; margin-bottom: 1rem;">‚ö†Ô∏è Recomendaciones Importantes</h3>
            <ul style="color: #856404; padding-left: 1.5rem; margin: 0;">
                <li><strong>Encabezados:</strong> Usa los nombres exactos de las columnas (respeta may√∫sculas/min√∫sculas y guiones bajos)</li>
                <li><strong>Fechas:</strong> Formato YYYY-MM-DD (ejemplo: 2024-03-15)</li>
                <li><strong>Valores booleanos:</strong> Usa true/false, 1/0, s√≠/no, o vac√≠o</li>
                <li><strong>Decimales:</strong> Puedes usar punto (.) o coma (,) como separador</li>
                <li><strong>Valores vac√≠os:</strong> Deja la celda en blanco si no tienes el dato</li>
                <li><strong>Para pruebas:</strong> Se recomienda m√°ximo 100 registros</li>
            </ul>
        </div>

        <div style="display: flex; gap: 1rem;">
            <button type="submit" class="btn btn-primary">üì§ Subir y Procesar</button>
            <a href="{% url 'accounts:lista_cargas' %}" class="btn btn-secondary">Cancelar</a>
        </div>
    </form>

    <!-- Secci√≥n de plantilla -->
    <div style="margin-top: 2rem; padding: 1.5rem; background: #e7f3ff; border-radius: 5px; text-align: center; border: 2px solid #667eea;">
        <div style="font-size: 2rem; margin-bottom: 0.5rem;">üìã</div>
        <p style="color: #004085; margin-bottom: 1rem; font-size: 1.1rem;">
            <strong>¬øPrimera vez o tienes dudas?</strong>
        </p>
        <p style="color: #004085; margin-bottom: 1.5rem;">
            Descarga la plantilla de ejemplo con la estructura correcta y columnas necesarias
        </p>
        <a href="{% url 'accounts:descargar_plantilla' %}" class="btn btn-primary" style="text-decoration: none; font-size: 1rem; padding: 0.75rem 2rem;">
            üì• Descargar Plantilla Excel
        </a>
    </div>
</div>

<script>
// Mostrar nombre y tama√±o del archivo seleccionado
document.getElementById('id_archivo').addEventListener('change', function(e) {
    const file = e.target.files[0];
    const fileNameDiv = document.getElementById('fileName');

    if (file) {
        const sizeMB = (file.size / (1024 * 1024)).toFixed(2);
        const sizeColor = sizeMB > 5 ? '#dc3545' : '#28a745';
        
        fileNameDiv.style.display = 'block';
        fileNameDiv.style.background = sizeMB > 5 ? '#f8d7da' : '#d4edda';
        fileNameDiv.style.color = sizeColor;
        fileNameDiv.style.borderLeft = `4px solid ${sizeColor}`;
        
        fileNameDiv.innerHTML = `
            <div style="display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                <span style="font-size: 1.5rem;">${sizeMB > 5 ? '‚ö†Ô∏è' : '‚úì'}</span>
                <div style="text-align: left;">
                    <div style="font-weight: 600;">${file.name}</div>
                    <div style="font-size: 0.9rem;">Tama√±o: ${sizeMB} MB ${sizeMB > 5 ? '(Excede el l√≠mite de 5MB)' : ''}</div>
                </div>
            </div>
        `;
    } else {
        fileNameDiv.style.display = 'none';
        fileNameDiv.innerHTML = '';
    }
});

// Mostrar informaci√≥n adicional seg√∫n el tipo de carga
document.getElementById('id_tipo_carga').addEventListener('change', function(e) {
    const tipo = e.target.value;
    const columnasExtras = document.getElementById('columnasExtras');

    if (tipo === 'FACTORES') {
        columnasExtras.style.display = 'list-item';
    } else {
        columnasExtras.style.display = 'none';
    }
});

// Inicializar en caso de que ya haya un valor seleccionado
document.addEventListener('DOMContentLoaded', function() {
    const tipoSelect = document.getElementById('id_tipo_carga');
    if (tipoSelect.value === 'FACTORES') {
        document.getElementById('columnasExtras').style.display = 'list-item';
    }
});
</script>

{% endblock %}