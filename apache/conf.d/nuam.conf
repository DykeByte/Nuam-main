# ========================================
# NUAM Virtual Host Configuration
# Apache2 (httpd) - Reverse Proxy to Nginx
# ========================================
# Architecture:
# Client → Apache2:80/443 → Nginx:80 → Services
# ========================================

# ========================================
# HTTP Virtual Host (Port 80)
# ========================================
<VirtualHost *:80>
    ServerName localhost
    ServerAlias nuam.local 127.0.0.1

    # Logging
    ErrorLog /proc/self/fd/2
    CustomLog /proc/self/fd/1 combined

    # Security Headers
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-XSS-Protection "1; mode=block"

    # Redirect HTTP to HTTPS (comment out if HTTPS not needed)
    # RewriteEngine On
    # RewriteCond %{HTTPS} off
    # RewriteRule ^(.*)$ https://%{HTTP_HOST}$1 [R=301,L]

    # ========================================
    # PROXY PASS TO NGINX
    # ========================================
    # All requests are forwarded to Nginx on port 80
    ProxyPreserveHost On
    ProxyPass / http://nginx:80/
    ProxyPassReverse / http://nginx:80/

    # Proxy headers
    RequestHeader set X-Forwarded-Proto "http"
    RequestHeader set X-Forwarded-Port "80"
    RequestHeader set X-Forwarded-For "%{REMOTE_ADDR}s"

    # ========================================
    # HEALTH CHECK ENDPOINT
    # ========================================
    <Location /apache-health>
        ProxyPass !
        SetHandler server-status
    </Location>

    # ========================================
    # TIMEOUT SETTINGS
    # ========================================
    ProxyTimeout 300
    Timeout 300
</VirtualHost>

# ========================================
# HTTPS Virtual Host (Port 443)
# ========================================
<VirtualHost *:443>
    ServerName localhost
    ServerAlias nuam.local 127.0.0.1

    # Logging
    ErrorLog /proc/self/fd/2
    CustomLog /proc/self/fd/1 combined

    # ========================================
    # SSL/TLS CONFIGURATION
    # ========================================
    SSLEngine on

    # SSL Certificate files (will be generated)
    SSLCertificateFile /usr/local/apache2/conf/ssl/nuam.crt
    SSLCertificateKeyFile /usr/local/apache2/conf/ssl/nuam.key

    # Modern TLS configuration
    SSLProtocol all -SSLv3 -TLSv1 -TLSv1.1
    SSLCipherSuite HIGH:!aNULL:!MD5:!3DES:!CAMELLIA:!AES128
    SSLHonorCipherOrder on

    # HSTS (HTTP Strict Transport Security)
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains"

    # ========================================
    # SECURITY HEADERS (HTTPS)
    # ========================================
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    Header always set Permissions-Policy "geolocation=(), microphone=(), camera=()"

    # ========================================
    # PROXY PASS TO NGINX (HTTPS → HTTP)
    # ========================================
    # SSL termination happens here, Nginx receives HTTP
    ProxyPreserveHost On
    SSLProxyEngine Off

    ProxyPass / http://nginx:80/
    ProxyPassReverse / http://nginx:80/

    # Proxy headers for HTTPS
    RequestHeader set X-Forwarded-Proto "https"
    RequestHeader set X-Forwarded-Port "443"
    RequestHeader set X-Forwarded-For "%{REMOTE_ADDR}s"
    RequestHeader set X-Forwarded-Ssl on

    # ========================================
    # WEBSOCKET SUPPORT
    # ========================================
    # For React hot reload and future WebSocket features
    RewriteEngine On
    RewriteCond %{HTTP:Upgrade} =websocket [NC]
    RewriteRule /(.*)           ws://nginx:80/$1 [P,L]
    RewriteCond %{HTTP:Upgrade} !=websocket [NC]
    RewriteRule /(.*)           http://nginx:80/$1 [P,L]

    # ========================================
    # RATE LIMITING (Optional - requires mod_ratelimit)
    # ========================================
    # <Location /api/>
    #     SetOutputFilter RATE_LIMIT
    #     SetEnv rate-limit 400
    # </Location>

    # ========================================
    # TIMEOUT SETTINGS
    # ========================================
    ProxyTimeout 300
    Timeout 300
    SSLProxyCheckPeerName off
    SSLProxyCheckPeerExpire off
</VirtualHost>

# ========================================
# ADDITIONAL NOTES
# ========================================
# Architecture Flow:
# 1. Client connects to Apache2 (port 80 or 443)
# 2. Apache2 handles SSL/TLS termination (if HTTPS)
# 3. Apache2 forwards to Nginx (port 80, plain HTTP)
# 4. Nginx routes to appropriate service:
#    - / → React Dashboard (port 3000)
#    - /api/v1/ → Django Core (port 8000)
#    - /currency-api/v1/ → Currency Service (port 8001)
#    - /admin/ → Django Admin (port 8000)
#    - /static/ → Static files
#    - /media/ → Media files
#
# Benefits of this architecture:
# - SSL termination at Apache2 layer
# - Apache2 handles security headers
# - Nginx handles routing and caching
# - Clean separation of concerns
# - Easy to add WAF (Web Application Firewall) later
# ========================================
